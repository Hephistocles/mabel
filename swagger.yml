swagger: '2.0'
info:
  description: API used to interact with the Mabel ticketing system
  version: 1.0.0
  title: Mabel API
  contact: {}
  license:
    name: GPLv2
    url: 'http://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html#SEC1'
host: 'PLACEHOLDER'
basePath: /api
consumes: []
produces:
  - application/json
schemes:
  - http
securityDefinitions:
  token:
    type: apiKey
    name: access_token
    in: query
  mabel:
    type: basic
  raven: # Need to figure out how to implement this (normally raven requires redirect)
    type: basic 
  admin:
    type: apiKey
    name: access_token
    in: query
  self: # NB Must only be used on operations for which the param {id} is the user id.
    type: apiKey
    name: access_token
    in: query
security: # default security is just to have an auth token
  - token: []

paths:
  /group:
    get:
      summary: Get all groups
      description: "Get all groups' details"
      security:
        - admin: []
      parameters: []
      responses:
        '200':
          description: Success. Returns details for all groups
          schema:
            items:
              $ref: '#/definitions/Group'
            type: array
    post:
      summary: Create a group
      description: "Create a new group with an automatically selected ID. Note that validation will fail if 'id' is provided."
      security:
        - admin: []
      parameters:
        - name: group
          in: body
          description: A specification of the group to be created.
          required: true
          schema:
            allOf:
              - $ref: '#/definitions/Group'
              - required:
                  - name
                  - description
                  - ticket_limit
                x-forbid:
                  - id
      responses:
        '200':
          description: Success. Returns the new group.
          schema:
            $ref: '#/definitions/Group'
  '/group/{id}':
    delete:
      summary: Delete a group
      description: Delete the group with the given ID
      security:
        - admin: []
      parameters:
        - name: id
          in: path
          minimum: 1
          description: The group ID to delete
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            properties:
              success:
                default: true
                type: boolean
            required:
              - name
            type: object
    get:
      summary: Get group details
      description: Get group details. Only accessible to admins.
      security:
        - admin: []
      parameters:
        - name: id
          in: path
          minimum: 1
          description: The group ID to retrieve
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/Group'
    put:
      summary: Modify a group
      description: "Update the group with the given ID. Note that the ID of the group cannot be changed, and validation will fail if 'id' is present as a property of the body"
      security:
        - admin: []
      parameters:
        - name: group
          in: body
          description: A specification of the group to be updated. Omitted properties will remain unchanged.
          required: true
          schema:
            allOf:
              - $ref: '#/definitions/Group'
              - x-forbid:
                  - id
        - name: id
          in: path
          minimum: 1
          description: The group ID to modify
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/Group'
  /payment-method:
    get:
      description: Get details for all payment methods available
      parameters: []
      responses:
        '200':
          description: Success
          schema:
            items:
              $ref: '#/definitions/PaymentMethod'
            type: array
      security:
        - token: []
      summary: Get all payment method details
  '/payment-method/{id}':
    get:
      summary: Get payment method details
      description: Get details for the given payment method
      security:
        - token: []
      parameters:
        - name: id
          in: path
          minimum: 1
          description: The payment method ID to retrieve
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/PaymentMethod'
  /ticket:
    delete:
      description: Cancel a bunch of tickets at once
      parameters:
        - name: ids
          in: query
          description: A csv list of ticket IDs for tickets to be deleted.
          required: true
          type: array
          format: csv
          items:
            type: number
            format: integer
      responses:
        '200':
          description: Success
          schema:
            properties:
              success:
                default: true
                type: boolean
            type: object
      security:
        - admin: []
      summary: Cancel ticket
    get:
      summary: Get all tickets
      description: "Get all tickets' details. Warning: likely to be big currently..."
      security:
        - admin: []
      parameters: []
      responses:
        '200':
          description: Success. Returns details for all tickets
          schema:
            items:
              $ref: '#/definitions/Ticket'
            type: array
    post:
      summary: Create a ticket
      description: 'Create a new ticket with an automatically allocated ID. This operation is designed for admin usage, and ticket validation is skipped. Users should use the /user/{id}/ticket route instead.'
      security:
        - admin: []
      parameters:
        - name: ticket
          in: body
          description: A specification of the ticket to be created.
          required: true
          schema:
            allOf:
              - $ref: '#/definitions/Ticket'
              - required:
                  - user_id
                  - ticket_type_id
                  - guest_name
                  - payment_method_id
                x-forbid:
                  - id
                  - registration_time
                  - transaction_value
      responses:
        '200':
          description: Success. Returns the nesly created ticket
          schema:
            $ref: '#/definitions/Ticket'
  '/ticket/{id}':
    get:
      summary: Get ticket details
      description: Retrieve details for the ticket with given ID (for admins)
      security:
        - token: []
      parameters:
        - name: id
          in: path
          minimum: 1
          description: The ticket ID to retrieve
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/Ticket'
    put:
      summary: Modify a ticket
      description: Update the ticket with the given ID using the details in the body
      security:
        - admin: []
      parameters:
        - name: ticket
          in: body
          description: A specification of the ticket to be updated. Omitted properties will remain unchanged.
          required: true
          schema:
            allOf:
              - $ref: '#/definitions/Ticket'
              - x-forbid:
                  - id
        - name: id
          in: path
          minimum: 1
          description: The ticket ID to modify
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/Ticket'
  /type:
    get:
      summary: Get all ticket types
      description: "Get all ticket types' details"
      security:
        - token: []
      parameters: []
      responses:
        '200':
          description: Success. Returns details for all ticket types
          schema:
            items:
              $ref: '#/definitions/TicketType'
            type: array
    post:
      summary: Create a ticket type
      description: Create a new ticket type with an automatically selected ID
      security:
        - admin: []
      parameters:
        - name: ticket_type
          in: body
          description: A specification of the ticket type to be created.
          required: true
          schema:
            allOf:
              - $ref: '#/definitions/TicketType'
              - x-forbid:
                  - id
      responses:
        '200':
          description: Success. Returns the new ticket type.
          schema:
            $ref: '#/definitions/TicketType'
  '/type/{id}':
    delete:
      summary: Delete a ticket type
      description: Delete the ticket type with the given ID
      security:
        - token: []
      parameters:
        - name: id
          in: path
          minimum: 1
          description: The ID of the ticket type to delete
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            properties:
              success:
                default: true
                type: boolean
            required:
              - name
            type: object
    get:
      summary: Get ticket type details
      description: Get ticket type details
      security:
        - token: []
      parameters:
        - name: id
          in: path
          minimum: 1
          description: The ticket type ID to retrieve
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/TicketType'
    put:
      summary: Modify a ticket type
      description: Update the ticket type with the given ID
      security:
        - token: []
      parameters:
        - name: ticket_type
          in: body
          description: "A specification of the ticket type to be updated. Omitted properties will remain unchanged. It is illegal to provide 'id' in the request body."
          required: true
          schema:
            allOf:
              - $ref: '#/definitions/TicketType'
              - x-forbid:
                  - id
        - name: id
          in: path
          minimum: 1
          description: The ID of the ticket type ID to modify
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/TicketType'
  '/user/{id}':
    get:
      summary: "Get a user's details"
      description: "Get a user's details. Normal users can only get themselves, admins can get anyone."
      security:
        - self: []
        - admin: []
      parameters:
        - name: id
          in: path
          minimum: 1
          description: The user ID to retrieve
          required: true
          type: integer
          format: int32
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/User'

  /token:
    get:
      summary: Get a new auth token
      description: Trade an existing auth token for a newer one which will expire later
      parameters:
        - name: access_token
          in: query
          description: The old token we want to replace
          type: string
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/Token'
  /token/mabel:
    get:
      summary: Get an auth token using mabel credentials
      description: Login using mabel credentials and get an authorization token for use with the rest of the API. Can either use basic authorization or pass in email and password as query parameters (not recommended outside of testbed)
      security:
        - mabel: []
      parameters:
        - name: email
          in: query
          description: The email address of the user trying to log in
          type: string
          format: email
        - name: password
          in: query
          description: The password of the user trying to log in
          type: string
          format: password
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/Token'
  /token/raven:
    get:
      summary: Get an auth token using Raven token
      description: Trade a Raven token for a mabel authorization token for use with the rest of the API.
      security:
        - raven: []
      responses:
        '200':
          description: Success
          schema:
            $ref: '#/definitions/Token'




definitions:
  Error:
    properties:
      message:
        type: string
      success:
        type: boolean
      error:
        type: object
    required:
      - message
      - success
      - error
  Absent:
    type: string
    enum: 
      - "Value must not be present"
    maxLength: 0
  Token: 
    properties:
      token:
        type: string
        # TODO: invalidate this token
        example: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdXRoIjp0cnVlLCJpZCI6MX0.lzALTSPB3iAHYBan5oBbJ23rV_NMfXKQpWCFATwaJwU
        description: An authorization token for use with the rest of the API

  TicketType:
    properties:
      id: 
        type: integer
        format: int32
        example: 1
        minimum: 1
        description: Ticket type identifier
        readOnly: true
      name:
        type: string
        example: Standard
        description: Name of the ticket type
      price: 
        type: number
        format: float
        example: 130.00
        minimum: 0
        description: The price per unit for a ticket of this type
      ticket_limit: 
        type: integer
        format: int32
        example: 1
        minimum: 0
        description: The total number of tickets of this type which may be sold
      per_user_limit: 
        type: integer
        format: int32
        example: 1
        minimum: 0
        description: The number of tickets of this type that a single user may hold (may be null)
      groups:
        type: array
        format: csv
        items:
          type: number
          format: integer
          minimum: 0



  User:
    properties:
      id:
        type: integer
        format: int32
        example: 1
        minimum: 1
        description: Mabel user identifier
        readOnly: true
      name:
        type: string
        example: Mabel User
        description: "User's name"
      email:
        type: string
        format: email
        example: mabel@mabelticketing.co.uk
        description: "User's email address"
      crsid:
        type: string
        example: ab123
        description: "User's CRSiD if they are a current student"
      registration_time:
        type: integer
        format: int32
        example: 14419663721
        readOnly: true
        description: 'Date the user registered (or first logged in via Raven, which counts as registration) - seconds since unix epoch'
      password_md5:
        type: string
        example: 5F4DCC3B5AA765D61D8327DEB882CF99
        description: "The MD5 hash of the user's password (will be null for raven users)"
      verification_code:
        type: string
        example: cJrE0uc4PzddPmr8AS6MBdKoQUdqYi9D
        readOnly: true
        description: The code emailed to new users when they register via mabel. They have to verify their email by returning the code to us (clicking the link in the email)
      is_verified:
        type: boolean
        example: false
        description: Whether the user is verified (i.e. allowed to buy tickets)
    description: ''

  Group:
    properties:
      id:
        type: integer
        format: int32
        example: 1
        minimum: 1
        readOnly: true
        description: Group identifier
      name:
        type: string
        example: Emmanuel Students
        description: Group name
      description:
        type: string
        example: Members who are currently students at Emmanuel College
        description: Group description
      ticket_limit:
        type: integer
        format: int32
        example: 8
        minimum: 0
        description: The number of tickets a member of this group may buy in total

  PaymentMethod:
    properties:
      id:
        type: integer
        format: int32
        example: 1
        minimum: 1
        readOnly: true
        description: Payment method identifier
      name:
        type: string
        example: College Bill
        description: Payment method name
      description:
        type: string
        example: Pay for tickets by adding the price to your end of term college bill
        description: Payment method description
      ticket_limit:
        type: integer
        format: int32
        example: 1
        minimum: 0
        description: The number of tickets which may be paid for using this payment method


  Ticket:
    properties:
      id:
        type: integer
        format: int32
        example: 1
        minimum: 1
        readOnly: true
        description: Ticket identifier
      user_id:
        type: integer
        format: int32
        example: 1
        minimum: 1
        description: User identifier for the ticket booker
      ticket_type_id:
        type: integer
        format: int32
        example: 1
        minimum: 1
        description: Ticket type identifier for this ticket
      guest_name:
        type: string
        example: Christopher Little
        default: 'Mabel Guest'
        description: The name which should be printed on this ticket
      payment_method_id:
        type: integer
        format: int32
        example: 1
        minimum: 1
        description: Payment method identifier for this ticket
      registration_time:
        type: integer
        format: int32
        example: 14419663721
        readOnly: true
        description: Date the ticket was booked (seconds since unix epoch)
      donation:
        type: boolean
        example: true
        default: false
        description: Whether the booker chose to make a donation which this ticket
      transaction_value:
        type: number
        format: float
        example: 130.00
        readOnly: true
        minimum: 0
        description: Redundant field indicating how much this ticket cost to book
      notes:
        type: string
        example: Half of this payment has been received by cheque
        default: ""
        description: Arbitrary notes field for admins to keep track of ticket perculiarities
      status:
        type: string
        example: PENDING
        description: "An indication of the ticket's status"
        default: PENDING
        enum: 
          - PENDING
          - CONFIRMED
          - CANCELLED
          - ADMITTED
          - PENDING_WL
          - CANCELLED_WL
