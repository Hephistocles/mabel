extends ./main.jade

block scripts
	// angular
	script(type="text/javascript", src="/components/angular/angular.js")
	script(type="text/javascript", src="/components/angular-cookies/angular-cookies.js")
	script(type="text/javascript", src="/components/angular-resource/angular-resource.js")
	
	// misc
	script(type="text/javascript", src="/components/moment/moment.js")

	// shared
	script(type="text/javascript", src="/js/shared/mabel.shared.js")
	script(type="text/javascript", src="/js/shared/mabelresource.factory.js")
	script(type="text/javascript", src="/js/shared/user.factory.js")
	script(type="text/javascript", src="/js/shared/datetimepicker.directive.js")
	script(type="text/javascript", src="/js/shared/apicaller.factory.js")
	script(type="text/javascript", src="/js/shared/mabeltoken.factory.js")
	
	// booking
	script(type = "text/javascript" src="/js/booking/mabel.booking.js")
	script(type = "text/javascript" src="/js/booking/booking.controller.js")

	// bootstrap
	script(type="text/javascript", src="/components/angular-bootstrap/ui-bootstrap.min.js")
	link(rel="stylesheet", type="text/css", href="/css/bootstrap-flatly.min.css")
	link(rel="stylesheet", type="text/css", href="/css/main.css")

block title
	//- Probably easiest to not use angular for this, and instead set document.title in javascript
	//- alternatively move the controller further up the html, or create a new 'title' controller
	title Mabel Ticketing | Booking

block content
	div(ng-app="mabel.booking" ng-controller="BookingController as bookingCtrl" ng-view)
		div(ng-switch="bookingCtrl.status")
			
			div(ng-switch-when="unavailable")
				.slide
					section.slide-content
						h2 Booking is currently unavailable
						.well
							p {{bookingCtrl.reason}}
							p Please do not refresh this page - the booking form will load automatically as soon as it is available.

			div(ng-switch-when="booking")
				.slide
					section.slide-content
						h1 Booking
						.well
							p(ng-if="bookingCtrl.meta.ticketAllowance <= 0") No tickets are currently available for you to book.
							form.form-horizontal(ng-submit="bookingCtrl.submitBooking()" novalidate, ng-if="bookingCtrl.meta.ticketAllowance > 0")
								fieldset
									legend Welcome {{ bookingCtrl.user.name }}, please select your tickets.
									p Guest names can be assigned to tickets after you make your booking.
									p You may book {{ bookingCtrl.meta.ticketAllowance }} ticket{{ bookingCtrl.meta.ticketAllowance===1?"":"s"}}.
									p If we are unable to book all the tickets you request, the remainder will be added to the waiting list instead.
									.form-group
										div.alert.alert-danger(ng-if="bookingCtrl.meta.errorMsg.length > 0")
											button.close(type="button", aria-label="Close", ng-click="bookingCtrl.meta.errorMsg = '';") 
												span(aria-hidden="true") &times;
											strong Error: 
											| {{bookingCtrl.meta.errorMsg}}
										.col-lg-10
											table.table
												thead
													tr
														th Ticket types
														th Price
														th Quantity

												tbody
													tr(ng-repeat="ticket in bookingCtrl.available_tickets", style="background-color:#ffffff;")
														td {{ ticket.name }}
														td £{{ ticket.price }}
														td
															div
																input(type="hidden" 
																	ng-model="bookingCtrl.booking.tickets[$index].ticket_type_id"
																	value="ticket.ticket_type_id")
																select(ng-model="bookingCtrl.booking.tickets[$index].quantity")
																	option(ng-value="$index" ng-repeat="i in [0].concat(bookingCtrl.booking.tickets[$index].max_tickets) track by $index") {{$index}}
																div(ng-if="bookingCtrl.booking.tickets[$index].max_tickets.length>bookingCtrl.booking.tickets[$index].max_available && bookingCtrl.booking.tickets[$index].max_available === 1")
																	em Only {{bookingCtrl.booking.tickets[$index].max_available}} ticket available
																div(ng-if="bookingCtrl.booking.tickets[$index].max_tickets.length>bookingCtrl.booking.tickets[$index].max_available && bookingCtrl.booking.tickets[$index].max_available > 1")
																	em Only {{bookingCtrl.booking.tickets[$index].max_available}} tickets available
																div(ng-if="bookingCtrl.booking.tickets[$index].max_available === 0")
																	em Sold out
									.form-group
										label.col-lg-2.control-label Donation
										.col-lg-10
											.checkbox
												label
													p
														input(type="checkbox", ng-model="bookingCtrl.booking.donate") 
														| I wish to make a charitable donation of #[b £2.00] per ticket to your charitable causes.
												p You can find out more about our charitable causes on our #[a(href="http://emmamayball.com") homepage].
									.form-group(ng-if="bookingCtrl.meta.ticketQuantity > 0")
										label.col-lg-2.control-label Summary
										.col-lg-10
											table.table.table-striped
												tbody(ng-repeat="ticketType in bookingCtrl.booking.tickets", ng-if="ticketType.quantity > 0")
													tr(style="background-color:#ffffff;")
														th {{ ticketType.name }} (£{{ ticketType.price | number:2 }}) 
													tr(ng-repeat="method in ticketType.payment_methods track by $index" style="background-color:#ffffff;")
														td Payment method for {{ticketType.name}} Ticket {{$index + 1}}: 
															select(ng-model="ticketType.payment_methods[$index]" ng-options="m.id as m.name for m in bookingCtrl.payment_methods")
																//- TODO: display appropriate ticket quantity options
																//- TODO: clarify where all this stuff is authenticated
																//- option(ng-value="m.id" ng-repeat="m in bookingCtrl.payment_methods") {{m.name}}
												tbody
													tr(ng-if="bookingCtrl.booking.donate", style="background-color:#ffffff;")
														td #[b Charitable donation @ £2.00 per ticket]
												tfoot
													tr.info
														td Total cost: #[b £{{ bookingCtrl.meta.bookingSum | number:2 }}]
									p(style="text-align:center;") 
										input.btn.btn-info(id="submitButton", type="submit", value="Confirm")

			div(ng-switch-when="done")
				p YOUR BOOKING HAS BEEN MADE ** DISPLAY BOOKING &amp; LINK TO MANAGEMENT PAGE ETC

