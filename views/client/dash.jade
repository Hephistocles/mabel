//- Copyright (C) 2015  Mabel Ticketing 
//- GNU General Public License v2.0
//- https://github.com/mabelticketing/mabel/blob/master/LICENSE.txt

extends ./main.jade

block scripts
	// angular
	script(type="text/javascript" src="/lib/components/angular/angular.js")
	script(type="text/javascript" src="/lib/components/angular-cookies/angular-cookies.js")
	script(type="text/javascript" src="/lib/components/angular-resource/angular-resource.js")
	
	// bootstrap
	script(type="text/javascript" src="/lib/components/angular-bootstrap/ui-bootstrap.min.js")
	script(type="text/javascript" src="/lib/components/moment/moment.js")

	// shared
	script(type="text/javascript" src="/js/shared/mabel.shared.js")
	script(type="text/javascript" src="/js/shared/apicaller.factory.js")
	script(type="text/javascript" src="/js/shared/mabeltoken.factory.js")
	script(type="text/javascript" src="/js/shared/mabelresource.factory.js")
	script(type="text/javascript" src="/js/shared/user.factory.js")

	// dash
	script(type="text/javascript" src="/js/dash/mabel.dash.js")
	script(type="text/javascript" src="/js/dash/dash.controller.js")

	// css
	link(rel="stylesheet", type="text/css", href="/css/main.css")

block title
	title Dashboard

block content
	div(ng-app="mabel.dash" ng-controller="DashController as dashCtrl" ng-view)
		
		h1 Dashboard - {{ dashCtrl.user.name }}

		//- .panel.panel-info
		//- 	.panel-heading The following tickets are available for booking:
		//- 	.panel-body
		//- 		p(ng-if="dashCtrl.ticketsAvailableLoading") #[em Loading...]
		//- 		p(ng-if="!dashCtrl.ticketsAvailableLoading && dashCtrl.ticketsAvailable.length === 0", style="font-style:italic;")
		//- 			| We couldn't find any tickets available to you.
		//- 		p(ng-if="(!dashCtrl.ticketsAvailableLoading) && dashCtrl.ticketsAvailable.length > 0 && dashCtrl.ticketsAvailable[0].allowance > 0")
		//- 			| You will be able to purchase {{dashCtrl.ticketsAvailable[0].allowance}} more ticket{{dashCtrl.ticketsAvailable[0].allowance===1?"":"s"}} of the following type:
		//- 			ul
		//- 				li(ng-repeat="ticket in dashCtrl.ticketsAvailable") #[b {{ ticket.name }}] - &pound;{{ ticket.price | number:2 }}
		
		p
			a.btn.btn-xlarge.btn-success(href="/book") Book tickets


		h2 Your tickets

		h3 Booked

		p(ng-if="dashCtrl.ticketsBookedLoading") #[em Loading...]

		p(ng-if="!dashCtrl.ticketsBookedLoading && !(dashCtrl.ticketsBooked.length > 0)") 
			em You have not yet booked any tickets. Once you have booked tickets, you will be able to review your orders here.


		table(ng-if="dashCtrl.ticketsBooked.length !== 0").table.table-striped.table-hover
			thead
				tr
					th(colspan=2) Ticket number
					th Guest name
					th Payment method
					th Price
					th Status
					th 
			tbody
				tr(ng-repeat="ticket in dashCtrl.ticketsBooked")
					td # {{ ticket.id }}
					td #[em ({{ ticket.name }})]
					td
						input(type="text" ng-model="ticket.guest_name" tabindex="{{$index + 1}}" ng-change="dashCtrl.setChanged(ticket);" ng-focus="dashCtrl.clearStatus(ticket)")

					//- TODO: allow users to change payment method
					td {{ ticket.payment_method }}
					td(style="text-align:	right") &pound;{{ ticket.transaction_value | number:2 }}
					td(class="{{ ticket.status }}") {{ ticket.status }}
					td(style="text-align:right")
						//- button.btn.btn-xs(ng-click="dashCtrl.saveTicket(ticket)") Save 
						button.btn.btn-xs.btn-danger(tabindex="-1", ng-click="dashCtrl.cancelTicket(ticket)") x
						span.label.label-notifier(class="label-{{ticket.id}} label-{{ticket._status}}") .
			tfoot
				tr
					th(colspan=2) Total
					td
					td
					td(style="text-align:right;")
						b &pound;{{ dashCtrl.totalValue | number:2 }}
					td
		p(style="font-size:2em; margin-top:20px; text-align:right;")
			button.btn.btn-large(class="btn-{{dashCtrl.saveBtnClass}}" ng-click="dashCtrl.saveTickets()") Save changes
		
		h3 Waiting List

		p(ng-if="dashCtrl.waitingListLoading") #[em Loading...]
		p(ng-if="!dashCtrl.transactionsLoading && !(dashCtrl.waitingListTickets.length > 0)") 
			em You are not currently in the waiting list for any tickets.
		table.table.table-striped.table-hover(ng-if="dashCtrl.waitingListTickets.length > 0")
			thead
				tr
					th Ticket Type
					th Payment Method
					th Price
					th 
			tbody
				tr(ng-repeat="ticket in dashCtrl.waitingListTickets")
					td {{ ticket.name }}
					//- TODO: allow users to change payment_methodment method
					td {{ ticket.payment_method }}
					td(style="text-align:right") &pound;{{ ticket.transaction_value | number:2 }}
					td(style="text-align:right")
						button.btn.btn-xs.btn-danger(tabindex="-1", ng-click="dashCtrl.cancelWaitingTicket(ticket)")  x
						span.label.label-notifier(class="label-{{ticket.id}} label-{{ticket._status}}") .


		//- h2 Billing
		//- p(ng-if="dashCtrl.transactionsLoading") #[em Loading...]
		//- div(ng-if="!dashCtrl.transactionsLoading && dashCtrl.transactions.length === 0")
		//- 	p #[em We have not yet processed any transactions from you.]
		//- table.table.table-striped.table-hover(ng-if="dashCtrl.transactions.length !== 0")
		//- 	thead
		//- 		tr
		//- 			th Payment Method
		//- 			th Notes
		//- 			th Value
		//- 			th Date Processed
		//- 	tbody
		//- 		tr(ng-repeat="transaction in dashCtrl.transactions")
		//- 			td {{ transaction.payment_method }}
		//- 			td {{ transaction.notes }}
		//- 			td &pound;{{ transaction.value | number: 2}}
		//- 			td {{ transaction.time }}
		//- 	tfoot
		//- 		tr 
		//- 			th Total
		//- 			td
		//- 			th &pound;{{ dashCtrl.totalTransactions | number: 2 }}
		//- 			td
